<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Electro - Electronics Website Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/static/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/static/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/static/lib/lightbox/css/lightbox.min.css" rel="stylesheet">


    <!-- Customized Bootstrap Stylesheet -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        /* Related items: fixed title height so all boxes are identical */
        #related-products-list .related-item .related-item-inner .text-center.rounded-bottom .related-item-title {
            min-height: 2.8em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Bottom list: fixed image height so all cards align */
        #related-products-list .related-item .related-item-inner .related-item-inner-item {
            height: 220px;
            overflow: hidden;
        }
        #related-products-list .related-item .related-item-inner .related-item-inner-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        /* Single product page: one consistent layout for all products */
        .product-tags-items { min-height: 2.5rem; }
        #featured-products-list { min-height: 4rem; }
    </style>
</head>

<body>

    <!-- Spinner Start -->
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->


    <!-- Navbar & Hero Start -->
    <div class="container-fluid nav-bar p-0">
        <div class="row gx-0 bg-primary px-5 align-items-center">
            <div class="col-lg-3 d-none d-lg-block">
                <nav class="navbar navbar-light position-relative" style="width: 250px;">
                    <button class="navbar-toggler border-0 fs-4 w-100 px-0 text-start" type="button"
                        data-bs-toggle="collapse" data-bs-target="#allCat">
                        <h4 class="m-0"><i class="fa fa-bars me-2"></i>All Categories</h4>
                    </button>
                    <div class="collapse navbar-collapse rounded-bottom" id="allCat">
                        <div class="navbar-nav ms-auto py-0">
                            <ul class="list-unstyled categories-bars">
                                <li>
                                    <div class="categories-bars-item">
                                        <a href="#">Accessories</a>
                                        <span>(3)</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="categories-bars-item">
                                        <a href="#">Electronics & Computer</a>
                                        <span>(5)</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="categories-bars-item">
                                        <a href="#">Laptops & Desktops</a>
                                        <span>(2)</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="categories-bars-item">
                                        <a href="#">Mobiles & Tablets</a>
                                        <span>(8)</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="categories-bars-item">
                                        <a href="#">SmartPhone & Smart TV</a>
                                        <span>(5)</span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="col-12 col-lg-9">
                <nav class="navbar navbar-expand-lg navbar-light bg-primary ">
                    <a href="" class="navbar-brand d-block d-lg-none">
                        <h1 class="display-5 text-secondary m-0"><i
                                class="fas fa-shopping-bag text-white me-2"></i>Electro</h1>
                        <!-- <img src="/static/img/logo.png" alt="Logo"> -->
                    </a>
                    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarCollapse">
                        <span class="fa fa-bars fa-1x"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarCollapse">
                        <div class="navbar-nav ms-auto py-0">
                            <a href="index.html" class="nav-item nav-link">Home</a>
                            <a href="shop.html" class="nav-item nav-link">Shop</a>
                            <a href="single.html" class="nav-item nav-link active">Single Page</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link" data-bs-toggle="dropdown"><span
                                        class="dropdown-toggle">Pages</span></a>
                                <div class="dropdown-menu m-0">
                                    <a href="bestseller.html" class="dropdown-item">Bestseller</a>
                                    <a href="cart.html" class="dropdown-item">Cart Page</a>
                                    <a href="cheackout.html" class="dropdown-item">Cheackout</a>
                                    <a href="404.html" class="dropdown-item">404 Page</a>
                                </div>
                            </div>
                            <a href="contact.html" class="nav-item nav-link me-2">Contact</a>
                            <div class="nav-item dropdown d-block d-lg-none mb-3">
                                <a href="#" class="nav-link" data-bs-toggle="dropdown"><span class="dropdown-toggle">All
                                        Category</span></a>
                                <div class="dropdown-menu m-0">
                                    <ul class="list-unstyled categories-bars">
                                        <li>
                                            <div class="categories-bars-item">
                                                <a href="#">Accessories</a>
                                                <span>(3)</span>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="categories-bars-item">
                                                <a href="#">Electronics & Computer</a>
                                                <span>(5)</span>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="categories-bars-item">
                                                <a href="#">Laptops & Desktops</a>
                                                <span>(2)</span>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="categories-bars-item">
                                                <a href="#">Mobiles & Tablets</a>
                                                <span>(8)</span>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="categories-bars-item">
                                                <a href="#">SmartPhone & Smart TV</a>
                                                <span>(5)</span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <a href="" class="btn btn-secondary rounded-pill py-2 px-4 px-lg-3 mb-3 mb-md-3 mb-lg-0"><i
                                class="fa fa-mobile-alt me-2"></i> +0123 456 7890</a>
                    </div>
                </nav>
            </div>
        </div>
    </div>
    <!-- Navbar & Hero End -->

    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
        <h1 class="text-center text-white display-6 wow fadeInUp" data-wow-delay="0.1s">Single Product</h1>
        <ol class="breadcrumb justify-content-center mb-0 wow fadeInUp" data-wow-delay="0.3s">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item"><a href="#">Pages</a></li>
            <li class="breadcrumb-item active text-white">Single Product</li>
        </ol>
    </div>
    <!-- Single Page Header End -->


    <!-- Single Products Start -->
    <div class="container-fluid shop py-5">
        <div class="container py-5">
            <div class="row g-4">
                <div class="col-lg-5 col-xl-3 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="input-group w-100 mx-auto d-flex mb-4">
                        <input type="search" class="form-control p-3" placeholder="keywords"
                            aria-describedby="search-icon-1">
                        <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                    </div>

                    <div class="featured-product mb-4">
                        <h4 class="mb-3">Similar products</h4>
                        <div id="featured-products-list">
                            <!-- Items will be loaded here via JS -->
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div id="sale-deal-box" style="min-height: 220px; height: 220px; overflow: hidden;">
                        <div class="spinner-border text-primary d-flex align-items-center justify-content-center" role="status" style="min-height: 220px;"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <div class="product-tags my-4">
                        <h4 class="mb-3">PRODUCT CATEGORIES</h4>
                        <div id="product-tags-items" class="product-tags-items bg-light rounded p-3">
                            <!-- Filled from product.categories via JS -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-7 col-xl-9 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="row g-4 single-product">
                        <div class="col-xl-6">
                            <div class="single-carousel owl-carousel">


                                <div class="single-item">
                                    <div class="single-inner bg-light rounded">
                                        <img id="main-product-image" src="/static/img/placeholder.png"
                                            class="img-fluid rounded" alt="Product" style="background: #f0f0f0;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6">
                            <h4 class="fw-bold mb-3" id="singleProductTitle">Smart Camera</h4>
                            <h5 class="fw-bold mb-3" id="singleProductPrice">3,35 $</h5>
                            <div class="d-flex mb-4">
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star text-secondary"></i>
                                <i class="fa fa-star"></i>
                            </div>
                            <div class="mb-3">
                                <div class="btn btn-primary d-inline-block rounded text-white py-1 px-4 me-2"><i
                                        class="fab fa-facebook-f me-1"></i> Share</div>
                                <div class="btn btn-secondary d-inline-block rounded text-white py-1 px-4 ms-2"><i
                                        class="fab fa-twitter ms-1"></i> Share</div>
                            </div>
                            <div class="d-flex flex-column mb-3">
                                <small>Product SKU: N/A</small>
                                <small>Available: <strong class="text-primary">20 items in stock</strong></small>
                            </div>
                            <p class="mb-4" id="singleProductDescription">The generated Lorem Ipsum is therefore always
                                free from repetition injected
                                humour, or non-characteristic words etc.</p>
                            <div class="input-group quantity mb-5" style="width: 100px;">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-minus rounded-circle bg-light border">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm text-center border-0" value="1">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <button id="singleProductAddToCart" onclick="addToCartCurrent()"
                                class="btn btn-primary border border-secondary rounded-pill px-4 py-2 mb-4 text-primary"><i
                                    class="fa fa-shopping-bag me-2 text-white"></i> Add to cart</button>
                        </div>
                        <div class="col-lg-12">
                            <div id="product-reviews-container">
                                <!-- Reviews will be loaded here via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Single Products End -->

    <!-- Related Product Start -->
    <div class="container-fluid related-product">
        <div class="container">
            <div class="mx-auto text-center pb-5" style="max-width: 700px;">
                <h4 class="text-primary mb-4 border-bottom border-primary border-2 d-inline-block p-2 title-border-radius wow fadeInUp"
                    data-wow-delay="0.1s">Related Products</h4>
            </div>

            <div id="related-products-list">
                <!-- Items will be loaded here via JS -->
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <!-- NOTE: Original related-carousel was here, replaced by dynamic list above or below. 
                 The user asked to change featured products content. 
                 Wait, "featured-product" was sidebar. "related-product" is here.
                 The user said: "in featured products change these static items...".
                 Featured items were in sidebar (replaced in previous turn). 
                 The "Related Products" section is conceptually similar but let's stick to what was asked.
                 I previously modified the SIDEBAR featured items.
                 Now I am modifying the Main Content (Description/Reviews).
            -->

            <script>
                function generateStars(rating) {
                    let starsHtml = '';
                    const ratingValue = parseFloat(rating) || 0;
                    for (let i = 0; i < 5; i++) {
                        starsHtml += (i < ratingValue) ? '<i class="fa fa-star text-secondary"></i> ' : '<i class="fa fa-star"></i> ';
                    }
                    return starsHtml;
                }

                function getRefFromPage() {
                    const params = new URLSearchParams(window.location.search);
                    let asin = params.get('asin');
                    let id = params.get('id');
                    if (!asin && !id) {
                        try {
                            const stored = localStorage.getItem('finfit_selected_product');
                            if (stored) {
                                const p = JSON.parse(stored);
                                asin = p.asin || null;
                                id = p.id || null;
                            }
                        } catch (e) {}
                    }
                    const qs = asin ? 'asin=' + encodeURIComponent(asin) : (id ? 'id=' + encodeURIComponent(id) : null);
                    return { asin, id, qs };
                }

                function setMainProduct(product) {
                    if (!product) return;
                    var title = (product.title || product.name) ? String(product.title || product.name) : 'Product';
                    var price = product.final_price != null ? product.final_price : product.price;
                    var priceStr = (price != null && price !== undefined && price !== '') ? (typeof price === 'number' ? price.toFixed(2) : String(price)) : '';
                    var imageUrl = (product.image_url || product.image || (product.image_urls && product.image_urls[0])) || '';
                    if (!imageUrl) imageUrl = '/static/img/placeholder.png';
                    var topReview = (product.top_review || product.topreview || '').trim() || '';

                    localStorage.setItem('finfit_selected_product', JSON.stringify({
                        asin: product.asin,
                        id: product.id,
                        title: title,
                        name: title,
                        final_price: price,
                        price: price,
                        description: (product.description != null && product.description !== undefined) ? String(product.description) : '',
                        image_url: imageUrl,
                        image: imageUrl,
                        category: (product.categories || product.category) || 'General',
                        rating: product.rating,
                        availability: product.availability,
                        top_review: topReview
                    }));

                    var reviewContainer = document.getElementById('product-reviews-container');
                    if (reviewContainer) {
                        if (topReview) {
                            var stars = (product.rating != null && product.rating !== undefined) ? generateStars(product.rating) : generateStars(4.5);
                            reviewContainer.innerHTML = '<div class="d-flex mb-3">' + stars + '</div><p class="mb-0">' + (topReview || '').replace(/</g, '&lt;') + '</p>';
                        } else {
                            reviewContainer.innerHTML = '<p class="text-muted mb-0">No reviews yet for this product.</p>';
                        }
                    }

                    var tagsContainer = document.getElementById('product-tags-items');
                    if (tagsContainer) {
                        var categories = [];
                        var raw = product.categories || product.category;
                        if (raw != null && raw !== undefined) {
                            try {
                                if (typeof raw === 'string') {
                                    var s = raw.trim();
                                    if (s.indexOf('[') === 0) {
                                        var match;
                                        var re = /\'([^\']*)\'/g;
                                        while ((match = re.exec(s)) !== null) categories.push(match[1].trim());
                                        if (categories.length === 0) {
                                            try {
                                                var parsed = JSON.parse(s.replace(/'/g, '"'));
                                                if (Array.isArray(parsed)) categories = parsed.map(function (c) { return (c && String(c).trim()) || ''; }).filter(Boolean);
                                            } catch (e2) {
                                                categories = s.replace(/^\[|\]$/g, '').split(',').map(function (x) { return x.replace(/^[\s'\"]+|[\s'\"]+$/g, '').trim(); }).filter(Boolean);
                                            }
                                        }
                                    } else {
                                        categories = s.split(',').map(function (x) { return x.trim(); }).filter(Boolean);
                                    }
                                } else if (Array.isArray(raw)) {
                                    categories = raw.map(function (c) { return (c && String(c).trim()) || ''; }).filter(Boolean);
                                }
                            } catch (e) {}
                        }
                        if (categories.length === 0 && (product.category || product.categories)) {
                            var one = (product.category || product.categories);
                            if (typeof one === 'string' && one.trim()) categories = [one.trim()];
                        }
                        tagsContainer.innerHTML = categories.length ? categories.map(function (cat) { return '<a href="shop.html" class="border rounded py-1 px-2 mb-2 me-1 d-inline-block text-decoration-none">' + (cat || '').replace(/</g, '&lt;') + '</a>'; }).join(' ') : '<span class="text-muted">—</span>';
                    }

                    var titleEl = document.getElementById('singleProductTitle');
                    var priceEl = document.getElementById('singleProductPrice');
                    var descEl = document.getElementById('singleProductDescription');
                    var descTabEl = document.getElementById('product-description-content');
                    var starsRow = document.querySelector('.single-product .d-flex.mb-4');

                    if (titleEl) titleEl.textContent = title;
                    if (priceEl) priceEl.textContent = priceStr ? priceStr + ' DT' : '— DT';
                    if (descEl) descEl.textContent = (product.description != null && product.description !== undefined) ? String(product.description) : '';
                    if (descTabEl) descTabEl.textContent = (product.description != null && product.description !== undefined) ? String(product.description) : '';

                    var mainImg = document.getElementById('main-product-image');
                    var safeTitle = (title && String(title) !== 'undefined' && String(title) !== 'null') ? String(title) : 'Product';
                    if (mainImg) {
                        mainImg.src = imageUrl;
                        mainImg.alt = safeTitle;
                    }
                    var carouselImgs = document.querySelectorAll('.single-carousel .single-item img');
                    for (var i = 0; i < carouselImgs.length; i++) {
                        carouselImgs[i].src = imageUrl;
                        carouselImgs[i].alt = safeTitle;
                    }

                    if (starsRow) starsRow.innerHTML = generateStars(product && product.rating != null ? product.rating : 0);
                }

                function renderSimilarSidebar(qs) {
                    const container = document.getElementById('featured-products-list');
                    if (!container) return;
                    fetch('/api/similar-products?' + qs + '&limit=5')
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data.ok && data.results.length > 0) {
                                container.innerHTML = '';
                                data.results.forEach(function (item) {
                                    const rating = parseFloat(item.rating) || 0;
                                    let starsHtml = '';
                                    for (let i = 0; i < 5; i++) starsHtml += (i < rating) ? '<i class="fa fa-star text-secondary"></i> ' : '<i class="fa fa-star"></i> ';
                                    const linkUrl = item.asin ? 'single.html?asin=' + encodeURIComponent(item.asin) : (item.id ? 'single.html?id=' + encodeURIComponent(item.id) : '#');
                                    const imgSrc = (item.image_url || item.image) || '/static/img/placeholder.png';
                                    const div = document.createElement('div');
                                    div.className = 'featured-product-item d-flex align-items-center mb-3';
                                    var itemPrice = (item.price != null && item.price !== undefined && item.price !== '') ? (typeof item.price === 'number' ? item.price.toFixed(2) : String(item.price)) : '0.00';
                                    div.innerHTML = '<a href="' + linkUrl + '" class="similar-product-link d-flex align-items-center text-decoration-none text-dark w-100" data-asin="' + (item.asin || '') + '" data-id="' + (item.id || '') + '"><div class="rounded me-4" style="width: 100px; height: 100px; flex-shrink: 0;"><img src="' + imgSrc + '" class="img-fluid rounded" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src=\'/static/img/placeholder.png\'"></div><div><h6 class="mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">' + (item.name || item.title || 'Product').replace(/</g, '&lt;') + '</h6><div class="d-flex mb-2">' + starsHtml + '</div><div class="d-flex mb-2"><h5 class="fw-bold me-2">' + itemPrice + ' DT</h5></div></div></a>';
                                    container.appendChild(div);
                                });
                            } else {
                                container.innerHTML = '<p>No similar products found.</p>';
                            }
                        })
                        .catch(function () { container.innerHTML = '<p>Could not load products.</p>'; });
                }

                function truncateTitleForBottomList(s, maxLen) {
                    s = (s || '').trim();
                    if (s.length <= maxLen) return s.replace(/</g, '&lt;');
                    var cut = s.substring(0, maxLen - 1);
                    var lastSpace = cut.lastIndexOf(' ');
                    var out = (lastSpace > 0 ? cut.substring(0, lastSpace) : cut) + '…';
                    return out.replace(/</g, '&lt;');
                }

                function renderRelatedSection(qs) {
                    const relatedContainer = document.getElementById('related-products-list');
                    if (!relatedContainer) return;
                    var BOTTOM_LIST_MAX_TITLE = 35;
                    fetch('/api/similar-products?' + qs + '&limit=5')
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (!data.ok || !data.results || data.results.length === 0) {
                                relatedContainer.innerHTML = '<p class="text-center">No related products found.</p>';
                                return;
                            }
                            var items = data.results;
                            var titles = items.map(function (it) { return it.name || 'Product'; });
                            return fetch('/api/shorten-titles', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ titles: titles, max_chars: BOTTOM_LIST_MAX_TITLE })
                            }).then(function (r) { return r.json(); }).then(function (shortResp) {
                                var shortTitles = (shortResp.ok && shortResp.short_titles && shortResp.short_titles.length) ? shortResp.short_titles : titles;
                                var carouselHtml = '<div class="related-carousel owl-carousel pt-4">';
                                for (var i = 0; i < items.length; i++) {
                                    var item = items[i];
                                    var linkUrl = item.asin ? 'single.html?asin=' + encodeURIComponent(item.asin) : (item.id ? 'single.html?id=' + encodeURIComponent(item.id) : '#');
                                    var imgSrc = (item.image_url || item.image) || '/static/img/placeholder.png';
                                    var starsHtml = generateStars(item.rating != null ? item.rating : 0);
                                    var rawTitle = shortTitles[i] || item.name || item.title || 'Product';
                                    var shortTitle = truncateTitleForBottomList(rawTitle, BOTTOM_LIST_MAX_TITLE);
                                    var avail = (item.availability || 'Available').replace(/</g, '&lt;');
                                    var rp = (item.price != null && item.price !== undefined && item.price !== '') ? (typeof item.price === 'number' ? item.price.toFixed(2) : String(item.price)) : '0.00';
                                    carouselHtml += '<div class="related-item rounded"><div class="related-item-inner border rounded"><div class="related-item-inner-item">' +
                                        '<a href="' + linkUrl + '"><img src="' + imgSrc + '" class="img-fluid w-100 rounded-top" alt="" onerror="this.src=\'/static/img/placeholder.png\'"></a>' +
                                        '<div class="related-details"><a href="' + linkUrl + '"><i class="fa fa-eye fa-1x"></i></a></div></div>' +
                                        '<div class="text-center rounded-bottom p-4"><a href="' + linkUrl + '" class="d-block mb-2">' + avail + '</a><a href="' + linkUrl + '" class="d-block h4 related-item-title">' + shortTitle + '</a><span class="text-primary fs-5">' + rp + ' DT</span></div></div>' +
                                        '<div class="related-item-add border border-top-0 rounded-bottom text-center p-4 pt-0"><a href="' + linkUrl + '" class="btn btn-primary border-secondary rounded-pill py-2 px-4 mb-4"><i class="fas fa-shopping-cart me-2"></i> Add To Cart</a>' +
                                        '<div class="d-flex justify-content-between align-items-center"><div class="d-flex">' + starsHtml + '</div><div class="d-flex"><a href="' + linkUrl + '" class="text-primary d-flex align-items-center justify-content-center me-3"><span class="rounded-circle btn-sm-square border"><i class="fas fa-random"></i></span></a><a href="' + linkUrl + '" class="text-primary d-flex align-items-center justify-content-center me-0"><span class="rounded-circle btn-sm-square border"><i class="fas fa-heart"></i></span></a></div></div></div></div>';
                                }
                                carouselHtml += '</div>';
                                relatedContainer.innerHTML = carouselHtml;
                                if (typeof $ !== 'undefined' && $.fn.owlCarousel) {
                                    try { $(relatedContainer).find('.related-carousel').owlCarousel('destroy'); } catch (e) {}
                                    $(relatedContainer).find('.related-carousel').owlCarousel({
                                        autoplay: true,
                                        smartSpeed: 1500,
                                        dots: false,
                                        loop: true,
                                        margin: 25,
                                        nav: true,
                                        navText: ['<i class="fas fa-chevron-left"></i>', '<i class="fas fa-chevron-right"></i>'],
                                        responsiveClass: true,
                                        responsive: { 0: { items: 1 }, 576: { items: 1 }, 768: { items: 2 }, 992: { items: 3 }, 1200: { items: 4 } }
                                    });
                                }
                            }).catch(function () {
                                var carouselHtml = '<div class="related-carousel owl-carousel pt-4">';
                                items.forEach(function (item, i) {
                                    var linkUrl = item.asin ? 'single.html?asin=' + encodeURIComponent(item.asin) : (item.id ? 'single.html?id=' + encodeURIComponent(item.id) : '#');
                                    var imgSrc = (item.image_url || item.image) || '/static/img/placeholder.png';
                                    var starsHtml = generateStars(item.rating != null ? item.rating : 0);
                                    var t = truncateTitleForBottomList(item.name || item.title || 'Product', 35);
                                    var avail = (item.availability || 'Available').replace(/</g, '&lt;');
                                    var rp = (item.price != null && item.price !== undefined && item.price !== '') ? (typeof item.price === 'number' ? item.price.toFixed(2) : String(item.price)) : '0.00';
                                    carouselHtml += '<div class="related-item rounded"><div class="related-item-inner border rounded"><div class="related-item-inner-item"><a href="' + linkUrl + '"><img src="' + imgSrc + '" class="img-fluid w-100 rounded-top" alt="" onerror="this.src=\'/static/img/placeholder.png\'"></a><div class="related-details"><a href="' + linkUrl + '"><i class="fa fa-eye fa-1x"></i></a></div></div><div class="text-center rounded-bottom p-4"><a href="' + linkUrl + '" class="d-block mb-2">' + avail + '</a><a href="' + linkUrl + '" class="d-block h4 related-item-title">' + t + '</a><span class="text-primary fs-5">' + rp + ' DT</span></div></div><div class="related-item-add border border-top-0 rounded-bottom text-center p-4 pt-0"><a href="' + linkUrl + '" class="btn btn-primary border-secondary rounded-pill py-2 px-4 mb-4"><i class="fas fa-shopping-cart me-2"></i> Add To Cart</a><div class="d-flex justify-content-between align-items-center"><div class="d-flex">' + starsHtml + '</div><div class="d-flex"><a href="' + linkUrl + '" class="text-primary d-flex align-items-center justify-content-center me-3"><span class="rounded-circle btn-sm-square border"><i class="fas fa-random"></i></span></a><a href="' + linkUrl + '" class="text-primary d-flex align-items-center justify-content-center me-0"><span class="rounded-circle btn-sm-square border"><i class="fas fa-heart"></i></span></a></div></div></div></div>';
                                });
                                carouselHtml += '</div>';
                                relatedContainer.innerHTML = carouselHtml;
                                if (typeof $ !== 'undefined' && $.fn.owlCarousel) {
                                    try { $(relatedContainer).find('.related-carousel').owlCarousel('destroy'); } catch (e) {}
                                    $(relatedContainer).find('.related-carousel').owlCarousel({ autoplay: true, smartSpeed: 1500, dots: false, loop: true, margin: 25, nav: true, navText: ['<i class="fas fa-chevron-left"></i>', '<i class="fas fa-chevron-right"></i>'], responsiveClass: true, responsive: { 0: { items: 1 }, 576: { items: 1 }, 768: { items: 2 }, 992: { items: 3 }, 1200: { items: 4 } } });
                                }
                            });
                        })
                        .catch(function () { relatedContainer.innerHTML = '<p class="text-center">Could not load products.</p>'; });
                }

                function loadProduct(asin, id) {
                    const qs = asin ? 'asin=' + encodeURIComponent(asin) : (id ? 'id=' + encodeURIComponent(id) : null);
                    if (!qs) {
                        document.getElementById('featured-products-list').innerHTML = '<p>Select a product to see similar items.</p>';
                        var rc = document.getElementById('related-products-list');
                        if (rc) rc.innerHTML = '<p class="text-center">Select a product to see similar items.</p>';
                        return;
                    }
                    fetch('/api/product-details?' + qs)
                        .then(function (r) { if (!r.ok) return {}; return r.json(); })
                        .catch(function () { return {}; })
                        .then(function (data) {
                            if (data && data.ok && data.product) {
                                setMainProduct(data.product);
                            } else {
                                var stored = localStorage.getItem('finfit_selected_product');
                                if (stored) {
                                    try {
                                        var p = JSON.parse(stored);
                                        var product = {
                                            id: p.id, asin: p.asin, title: p.name || p.title || 'Product',
                                            name: p.name || p.title, final_price: p.price || p.final_price,
                                            price: p.price || p.final_price, description: p.description || '',
                                            image_url: p.image || p.image_url, image: p.image || p.image_url,
                                            categories: p.category || p.categories, category: p.category,
                                            rating: p.rating, availability: p.availability, top_review: p.top_review
                                        };
                                        setMainProduct(product);
                                    } catch (e) {}
                                }
                            }
                            renderSimilarSidebar(qs);
                            renderRelatedSection(qs);
                        })
                        .catch(function () {
                            var stored = localStorage.getItem('finfit_selected_product');
                            if (stored) {
                                try {
                                    var p = JSON.parse(stored);
                                    var product = {
                                        id: p.id, asin: p.asin, title: p.name || p.title || 'Product',
                                        name: p.name || p.title, final_price: p.price || p.final_price,
                                        price: p.price || p.final_price, description: p.description || '',
                                        image_url: p.image || p.image_url, image: p.image || p.image_url,
                                        categories: p.category || p.categories, category: p.category,
                                        rating: p.rating, availability: p.availability, top_review: p.top_review
                                    };
                                    setMainProduct(product);
                                } catch (e) {}
                            }
                            renderSimilarSidebar(qs);
                            renderRelatedSection(qs);
                        });
                }

                var saleDealIndex = 0;
                var saleDealItems = [];

                function renderSaleDeal(item) {
                    var box = document.getElementById('sale-deal-box');
                    if (!box) return;
                    var linkUrl = item.asin ? 'single.html?asin=' + encodeURIComponent(item.asin) : (item.id ? 'single.html?id=' + encodeURIComponent(item.id) : '#');
                    var imgSrc = (item.image_url || item.image) || '/static/img/placeholder.png';
                    var discount = item.discount != null ? Math.round(Number(item.discount)) : 50;
                    box.innerHTML = '<a href="' + linkUrl + '" class="text-decoration-none d-block position-relative rounded" style="height: 220px; overflow: hidden;">' +
                        '<img src="' + imgSrc + '" class="img-fluid w-100 h-100 rounded" alt="" style="object-fit: cover; object-position: center;" onerror="this.src=\'/static/img/placeholder.png\'">' +
                        '<div class="text-center position-absolute d-flex flex-column align-items-center justify-content-center rounded p-4" style="width: 100%; height: 100%; top: 0; left: 0; background: rgba(242, 139, 0, 0.35);">' +
                        '<h5 class="display-6 text-primary fw-bold">' + discount + '% OFF</h5>' +
                        '<h6 class="text-dark mb-2" style="font-size: 0.9rem; max-height: 2.4em; overflow: hidden; text-overflow: ellipsis;">' + (item.name || 'Deal').replace(/</g, '&lt;') + '</h6>' +
                        '<span class="btn btn-primary rounded-pill px-4">Shop Now</span>' +
                        '</div></a>';
                }

                function loadSaleDeals() {
                    var box = document.getElementById('sale-deal-box');
                    if (!box) return;
                    fetch('/api/discounted-products?min_discount=30&limit=10')
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data.ok && data.results && data.results.length > 0) {
                                saleDealItems = data.results;
                                saleDealIndex = 0;
                                renderSaleDeal(saleDealItems[0]);
                                if (saleDealItems.length > 1) {
                                    setInterval(function () {
                                        saleDealIndex = (saleDealIndex + 1) % saleDealItems.length;
                                        renderSaleDeal(saleDealItems[saleDealIndex]);
                                    }, 4000);
                                }
                            } else {
                                box.innerHTML = '<div class="bg-light rounded p-4 text-center text-muted d-flex align-items-center justify-content-center" style="height: 220px;"><small>No deals 30%+ right now. Check back later!</small></div>';
                            }
                        })
                        .catch(function () {
                            box.innerHTML = '<div class="bg-light rounded p-4 text-center text-muted d-flex align-items-center justify-content-center" style="height: 220px;"><small>Deals unavailable.</small></div>';
                        });
                }

                document.addEventListener('DOMContentLoaded', function () {
                    var ref = getRefFromPage();
                    loadProduct(ref.asin, ref.id);
                    loadSaleDeals();
                });
            </script>
        </div>
    </div>
    </div>
    </div>
    </div>
    <!-- Single Products End -->

    <!-- Footer Start -->
    <div class="container-fluid footer py-5 wow fadeIn" data-wow-delay="0.2s">
        <div class="container py-5">
            <div class="row g-4 rounded mb-5" style="background: rgba(255, 255, 255, .03);">
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="rounded p-4">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-4"
                            style="width: 70px; height: 70px;">
                            <i class="fas fa-map-marker-alt fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h4 class="text-white">Address</h4>
                            <p class="mb-2">123 Street New York.USA</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="rounded p-4">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-4"
                            style="width: 70px; height: 70px;">
                            <i class="fas fa-envelope fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h4 class="text-white">Mail Us</h4>
                            <p class="mb-2">info@example.com</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="rounded p-4">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-4"
                            style="width: 70px; height: 70px;">
                            <i class="fa fa-phone-alt fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h4 class="text-white">Telephone</h4>
                            <p class="mb-2">(+012) 3456 7890</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="rounded p-4">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-4"
                            style="width: 70px; height: 70px;">
                            <i class="fab fa-firefox-browser fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h4 class="text-white">Yoursite@ex.com</h4>
                            <p class="mb-2">(+012) 3456 7890</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-5">
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <div class="footer-item">
                            <h4 class="text-primary mb-4">Newsletter</h4>
                            <p class="text-white mb-3">Dolor amet sit justo amet elitr clita ipsum elitr est.Lorem ipsum
                                dolor sit amet, consectetur adipiscing elit consectetur adipiscing elit.</p>
                            <div class="position-relative mx-auto rounded-pill">
                                <input class="form-control rounded-pill w-100 py-3 ps-4 pe-5" type="text"
                                    placeholder="Enter your email">
                                <button type="button"
                                    class="btn btn-primary rounded-pill position-absolute top-0 end-0 py-2 mt-2 me-2">SignUp</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="text-primary mb-4">Customer Service</h4>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Contact Us</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Returns</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Order History</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Site Map</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Testimonials</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> My Account</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Unsubscribe Notification</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="text-primary mb-4">Information</h4>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> About Us</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Delivery infomation</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Privacy Policy</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Terms & Conditions</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Warranty</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> FAQ</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Seller Login</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 col-xl-3">
                    <div class="footer-item d-flex flex-column">
                        <h4 class="text-primary mb-4">Extras</h4>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Brands</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Gift Vouchers</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Affiliates</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Wishlist</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Order History</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Track Your Order</a>
                        <a href="#" class=""><i class="fas fa-angle-right me-2"></i> Track Your Order</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->


    <!-- Copyright Start -->
    <div class="container-fluid copyright py-4">
        <div class="container">
            <div class="row g-4 align-items-center">
                <div class="col-md-6 text-center text-md-start mb-md-0">
                    <span class="text-white"><a href="#" class="border-bottom text-white"><i
                                class="fas fa-copyright text-light me-2"></i>Your Site Name</a>, All right
                        reserved.</span>
                </div>
                <div class="col-md-6 text-center text-md-end text-white">

                    <!--/*** This template is free as long as you keep the below authorâ€™s credit link/attribution link/backlink. ***/-->
                    <!--/*** If you'd like to use the template without the below authorâ€™s credit link/attribution link/backlink, ***/-->
                    <!--/*** you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". ***/-->
                    Designed By <a class="border-bottom text-white" href="https://htmlcodex.com">HTML Codex</a>.
                    Distributed By <a class="border-bottom text-white" href="https://themewagon.com">ThemeWagon</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Copyright End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-primary btn-lg-square back-to-top"><i class="fa fa-arrow-up"></i></a>

    <!-- AI Chatbot UI -->
    <div class="ai-chatbot-btn" onclick="toggleChat()" title="Ask our AI Assistant">
        <i class="fas fa-robot"></i>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-robot me-2"></i>
                <h5>FinFit AI Assistant</h5>
            </div>
            <div class="close-chat" onclick="toggleChat()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-message message-ai">
                Hello! I'm your FinFit assistant. How can I help you find the best electronics today?
            </div>
        </div>
        <div class="chat-footer">
            <div class="chat-input-group">
                <input type="text" id="chatInput" placeholder="Ask me anything..."
                    onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button class="send-btn" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/lib/wow/wow.min.js"></script>
    <script src="/static/lib/easing/easing.min.js"></script>
    <script src="/static/lib/waypoints/waypoints.min.js"></script>
    <script src="/static/lib/counterup/counterup.min.js"></script>
    <script src="/static/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/static/lib/lightbox/js/lightbox.min.js"></script>


    <!-- Template Javascript -->
    <script src="/static/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadProductDetails();
        });

        function loadProductDetails() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('asin') || params.get('id')) {
                return;
            }
            const productJson = localStorage.getItem('finfit_selected_product');
            if (!productJson) {
                window.location.href = 'shop.html';
                return;
            }

            const product = JSON.parse(productJson);

            // Populate Text Fields (never show "undefined")
            var prodTitle = product.name || product.title || 'Product Name';
            document.getElementById('singleProductTitle').textContent = prodTitle ? String(prodTitle) : 'Product';

            const price = product.price ?? product.final_price ?? 0;
            var priceDisplay = (price != null && price !== undefined && price !== '') ? (typeof price === 'number' ? price.toFixed(2) : String(price)) + ' DT' : '— DT';
            document.getElementById('singleProductPrice').textContent = priceDisplay;

            if (product.description != null && product.description !== undefined) {
                document.getElementById('singleProductDescription').textContent = String(product.description);
            }

            var topReview = (product.top_review || product.topreview || '').trim();
            var reviewContainer = document.getElementById('product-reviews-container');
            if (reviewContainer) {
                if (topReview) {
                    reviewContainer.innerHTML = '<p class="mb-0">' + topReview.replace(/</g, '&lt;') + '</p>';
                } else {
                    reviewContainer.innerHTML = '<p class="text-muted mb-0">No reviews yet for this product.</p>';
                }
            }

            var tagsContainer = document.getElementById('product-tags-items');
            if (tagsContainer) {
                var cats = [];
                var raw = product.categories || product.category;
                if (raw != null && raw !== undefined) {
                    if (typeof raw === 'string') {
                        var s = raw.trim();
                        if (s.indexOf('[') === 0) {
                            var re = /\'([^\']*)\'/g, m;
                            while ((m = re.exec(s)) !== null) cats.push(m[1].trim());
                            if (cats.length === 0) try { var p = JSON.parse(s.replace(/'/g, '"')); if (Array.isArray(p)) cats = p.map(function (c) { return (c && String(c).trim()) || ''; }).filter(Boolean); } catch (e2) { cats = s.replace(/^\[|\]$/g, '').split(',').map(function (x) { return x.replace(/^[\s'\"]+|[\s'\"]+$/g, '').trim(); }).filter(Boolean); }
                        } else cats = s.split(',').map(function (x) { return x.trim(); }).filter(Boolean);
                    } else if (Array.isArray(raw)) cats = raw.map(function (c) { return (c && String(c).trim()) || ''; }).filter(Boolean);
                }
                if (cats.length === 0 && (product.category || product.categories)) { var one = (product.category || product.categories); if (typeof one === 'string' && one.trim()) cats = [one.trim()]; }
                tagsContainer.innerHTML = cats.length ? cats.map(function (cat) { return '<a href="shop.html" class="border rounded py-1 px-2 mb-2 me-1 d-inline-block text-decoration-none">' + (cat || '').replace(/</g, '&lt;') + '</a>'; }).join(' ') : '<span class="text-muted">—</span>';
            }

            // Populate Images (Handling the carousel is tricky with static HTML structure, 
            // simpliest way is to update all images to the main product image for now)
            const imageUrl = product.image || (product.image_urls && product.image_urls[0]) || '/static/img/placeholder.png';
            var safeAlt = (prodTitle && String(prodTitle) !== 'undefined' && String(prodTitle) !== 'null') ? String(prodTitle) : 'Product';

            // Update carousel images (set alt to avoid "undefined" under image)
            const carouselImages = document.querySelectorAll('.single-carousel .single-item img');
            carouselImages.forEach(img => {
                img.src = imageUrl;
                img.alt = safeAlt;
            });

            // Re-initialize carousel if needed, or just relying on existing init might be flaky if DOM changed too much.
            // Since we just swapped src, it should be fine.
        }

        function getCartKey() {
            try {
                var u = localStorage.getItem('finfit_user');
                if (u) { var o = JSON.parse(u); if (o && o.email) return 'finfit_cart_' + String(o.email); }
            } catch (e) {}
            return 'finfit_cart';
        }

        function addToCartCurrent() {
            if (!checkAuth()) return;
            const productJson = localStorage.getItem('finfit_selected_product');
            if (!productJson) return;
            const product = JSON.parse(productJson);

            let cart = JSON.parse(localStorage.getItem(getCartKey()) || 'null') || [];

            const existingItem = cart.find(item => item.name === product.name);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    name: product.name,
                    price: product.price || product.final_price || 0,
                    image: product.image || (product.image_urls && product.image_urls[0]) || '/static/img/placeholder.png',
                    quantity: 1
                });
            }

            localStorage.setItem(getCartKey(), JSON.stringify(cart));
            alert(`Added ${product.name} to cart!`);

            // Update header counter if possible (requires reloading or shared function)
            // Ideally we'd call updateCounters() if it was shared or duplicated here.
            // For now, reload or just let the user see it next page load.
        }

        // Chatbot Functions

        // Chatbot Functions
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('active');
            if (chatWindow.classList.contains('active')) {
                document.getElementById('chatInput').focus();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const chatBody = document.getElementById('chatBody');
            const message = input.value.trim();

            if (message === '') return;

            // Add User Message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message message-user';
            userMsgDiv.textContent = message;
            chatBody.appendChild(userMsgDiv);

            // Clear Input
            input.value = '';

            // Add Loading Indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message message-ai loading';
            loadingDiv.innerHTML = '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> Thinking...';
            loadingDiv.id = 'ai-loading';
            chatBody.appendChild(loadingDiv);

            // Scroll to bottom
            chatBody.scrollTop = chatBody.scrollHeight;

            // Call Backend RAG API
            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    // Remove Loading
                    const loader = document.getElementById('ai-loading');
                    if (loader) loader.remove();

                    // Add AI Message
                    const aiMsgDiv = document.createElement('div');
                    aiMsgDiv.className = 'chat-message message-ai';
                    // Handing basic markdown/newlines
                    aiMsgDiv.innerHTML = data.response.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                    chatBody.appendChild(aiMsgDiv);
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                    const loader = document.getElementById('ai-loading');
                    if (loader) loader.remove();

                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chat-message message-ai text-danger';
                    errorDiv.textContent = "Oops! I hit a snag. Please check your connection and try again.";
                    chatBody.appendChild(errorDiv);
                });
        }

    </script>
</body>

</html>